{
  "meta": {
    "project": "HTU Smart Advisor",
    "date": "2026-02-21",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "HTU Smart Advisor is an academic advising and course-tracking platform for HTU students that supports degree progress tracking, semester planning, GPA projection, and integrations with Google Calendar and Notion, plus an admin analytics dashboard.",
  "core_goals": [
    "Enable students to track degree progress and completed courses across supported majors with prerequisite and elective rules enforced",
    "Provide an editable semester planner with GPA calculation, study sessions, and export/integration capabilities (Google Calendar, Notion)",
    "Support secure authentication (credentials + Google OAuth) and per-student persistence (profiles, progress, planner, integration tokens)",
    "Expose admin APIs for analytics, visitor logs, and safe database management operations",
    "Keep APIs simple, predictable, and enforce server-side authorization and business rules (e.g., session validation, elective caps, prerequisite locks)"
  ],
  "features": [
    {
      "name": "Authentication",
      "description": "Sign in with university ID+password or Google OAuth, claim new accounts, maintain session state, and sign out.",
      "user_flows": [
        "POST /api/auth/signin/credentials with body { student_id: \"S12345\", password: \"secret\" } -> Receive 200 with session cookie/JWT and user info from NextAuth -> GET /api/auth/session with session cookie -> Receive 200 with { user: { id, name, email, student_id } } (happy path)",
        "POST /api/auth/signin/credentials with body { student_id: \"S12345\", password: \"wrong\" } -> Receive 401 Invalid credentials (error: invalid credentials)",
        "POST /api/auth/signin/credentials with body { student_id: \"S99999\", password: \"securepwd\", is_claiming: \"true\" } -> Receive 200 with session created (new account claimed) (happy path for account claiming)",
        "POST /api/auth/signin/credentials with body { student_id: \"S12345\", password: \"short\", is_claiming: \"true\" } -> Receive 400 password too short OR 409 student_id already exists (error: claim rejected)",
        "POST /api/auth/signout with session cookie -> Receive 200 Session destroyed -> GET /api/auth/session -> Receive 200 with { user: null } (sign-out flow)"
      ]
    },
    {
      "name": "Course Catalog API",
      "description": "Public endpoint returning a flat, sorted list of all courses for client-side autocomplete and course selection.",
      "user_flows": [
        "GET /api/courses (no auth) -> Receive 200 with Array of { name: string, code: string, ch: number } (happy path)",
        "GET /api/courses (no auth) -> Receive 200 with empty array when no courses present (edge case)",
        "GET /api/courses (no auth) -> Receive 500 with error message when service/database error occurs (error flow)"
      ]
    },
    {
      "name": "Student Profile API",
      "description": "Read and update a student's saved major; calls require the session to match the target studentId.",
      "user_flows": [
        "POST /api/auth/signin/credentials with valid student credentials -> Receive 200 with session cookie -> GET /api/profile/{studentId} with session cookie where session.user.student_id == {studentId} -> Receive 200 { major: string | null } (happy path: read profile)",
        "POST /api/profile/{studentId}/save with session cookie and body { major: \"Computer Science\" } where session.user.student_id == {studentId} -> Receive 200 { success: true } -> GET /api/profile/{studentId} -> Receive 200 { major: \"Computer Science\" } (happy path: update profile)",
        "GET /api/profile/{studentId} without session or with session.user.student_id != {studentId} -> Receive 401 Unauthorized (error: access denied)",
        "POST /api/profile/{studentId}/save with session cookie but missing/invalid body (e.g., { major: \"\" }) -> Receive 400 Bad Request (error: validation failure)"
      ]
    },
    {
      "name": "Student Progress API (Course Tracking)",
      "description": "Retrieve and persist completed courses per student per major; server enforces prerequisites and elective caps.",
      "user_flows": [
        "POST /api/auth/signin/credentials with valid credentials -> Receive 200 with session cookie -> GET /api/progress/{studentId}?major=Computer%20Science with session cookie -> Receive 200 { completed: [ { code, name } ] } (happy path: load progress)",
        "POST /api/progress/{studentId}/save with session cookie and body { major: \"Computer Science\", completed: [ { code: \"CS101\", name: \"Intro to CS\" } ] } where session.user.student_id == {studentId} -> Receive 200 { success: true } -> GET /api/progress/{studentId}?major=Computer%20Science -> Receive 200 with updated completed array (happy path: save progress)",
        "POST /api/progress/{studentId}/save with session cookie but body includes a course whose prerequisites are not met -> Receive 400 { error: \"prerequisite_not_met\", details: [...] } (error: business rule enforcement)",
        "GET /api/progress/{studentId}?major=Computer%20Science without session or mismatched session -> Receive 401 Unauthorized (error: access denied)"
      ]
    },
    {
      "name": "Semester Planner API",
      "description": "Load, save/update, and delete a student's semester planner (courses table, study sessions, GPA calculations).",
      "user_flows": [
        "POST /api/auth/signin/credentials with valid credentials -> Receive 200 with session cookie -> GET /api/planner with session cookie -> Receive 200 { id, name, courses: [...], studySessions: [...] } (happy path: load planner)",
        "POST /api/planner with session cookie and body { id: \"sem123\", name: \"Spring 2026\", courses: [...], studySessions: [...] } -> Receive 200 { success: true } -> GET /api/planner -> Receive 200 with saved planner data (happy path: save/update planner)",
        "DELETE /api/planner with session cookie -> Receive 200 { success: true } -> GET /api/planner -> Receive 200 with empty/default planner (happy path: delete planner)",
        "GET /api/planner without session cookie -> Receive 401 Unauthorized (error: session required)",
        "POST /api/planner with session cookie but invalid payload structure -> Receive 400 Bad Request (error: validation failure)"
      ]
    },
    {
      "name": "Google Calendar Integration",
      "description": "Push midterm and final exam dates as Google Calendar events; OAuth callback exchanges code for tokens and stores them per-student.",
      "user_flows": [
        "POST /api/auth/signin/credentials with valid credentials -> Receive 200 with session cookie -> POST /api/integrations/google-calendar with session cookie and body { courses: [ { name, midtermDate, finalDate, credits } ] } and with stored Google OAuth token in DB -> Receive 200 { success: true, eventsCreated: number } (happy path: push events)",
        "POST /api/integrations/google-calendar with session cookie but no stored Google OAuth token -> Receive 401 Unauthorized (error: missing integration token)",
        "GET /api/integrations/google-calendar/callback?code=AUTH_CODE (user completes Google OAuth) -> Receive 302 Redirect to /planner after server exchanges code for tokens and stores them (happy path: OAuth callback)",
        "GET /api/integrations/google-calendar/callback without code or with invalid code -> Receive 400 or 401 and no redirect (error: oauth exchange failed)"
      ]
    },
    {
      "name": "Notion Integration",
      "description": "Sync planner/courses to a user's Notion database and create a Study Plan page via OAuth-backed integration.",
      "user_flows": [
        "POST /api/auth/signin/credentials with valid credentials -> Receive 200 with session cookie -> POST /api/integrations/notion with session cookie and body { courses: [...], semesterName: \"Spring 2026\", createNewPage: true } and with stored Notion OAuth token -> Receive 200 { success: true } (happy path: sync to Notion)",
        "POST /api/integrations/notion with session cookie but no stored Notion token -> Receive 401 Unauthorized (error: missing integration token)",
        "GET /api/integrations/notion/callback?code=AUTH_CODE -> Receive 302 Redirect to /planner after server exchanges code for access token and creates/links the Study Plan page (happy path: OAuth callback)",
        "GET /api/integrations/notion/callback with invalid/expired code -> Receive 400 or 401 and no redirect (error: oauth exchange failed)"
      ]
    },
    {
      "name": "Admin Analytics API",
      "description": "Admin-only analytics and visitor logs for dashboards; protected by the x-admin-secret header.",
      "user_flows": [
        "GET /api/admin/stats with header x-admin-secret set to ADMIN_SECRET -> Receive 200 { totalStudents, visitorCount, majorDistribution, progressDistribution, topCourses, trafficTrends, deviceBreakdown, recentActivity, heatmap, studentData } (happy path: fetch analytics)",
        "GET /api/admin/logs with header x-admin-secret set to ADMIN_SECRET -> Receive 200 Array of recent visitor log entries (happy path: fetch logs)",
        "GET /api/admin/stats without x-admin-secret or with invalid secret -> Receive 401 Unauthorized - missing or invalid x-admin-secret header (error: access denied)",
        "GET /api/admin/logs without x-admin-secret or with invalid secret -> Receive 401 Unauthorized - missing or invalid x-admin-secret header (error: access denied)"
      ]
    },
    {
      "name": "Database Management API",
      "description": "Admin endpoints to initialize or fully reset database tables; both actions require the admin secret and are destructive (reset).",
      "user_flows": [
        "POST /api/setup with header x-admin-secret set to ADMIN_SECRET -> Receive 200 { success: true } (happy path: initialize tables without dropping data)",
        "POST /api/reset with header x-admin-secret set to ADMIN_SECRET -> Receive 200 { success: true } (happy path: nuclear reset - drops and re-creates all tables)",
        "POST /api/setup without x-admin-secret or with invalid secret -> Receive 401 Unauthorized - missing or invalid x-admin-secret header (error: access denied)",
        "POST /api/reset without x-admin-secret or with invalid secret -> Receive 401 Unauthorized - missing or invalid x-admin-secret header (error: access denied)"
      ]
    }
  ],
  "code_summary": {
    "version": "2",
    "type": "backend",
    "tech_stack": [
      "TypeScript",
      "Next.js 16 (App Router)",
      "NextAuth v4",
      "Vercel Postgres",
      "bcryptjs",
      "Tailwind CSS"
    ],
    "features": [
      {
        "name": "Course Catalog API",
        "description": "Returns a flat sorted list of all courses across all majors for autocomplete",
        "files": [
          "app/api/courses/route.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/courses",
            "description": "List all courses for autocomplete",
            "auth_required": false,
            "response_schema": {
              "200": "Array of {name: string, code: string, ch: number}"
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "Student Profile API",
        "description": "CRUD operations for student major selection",
        "files": [
          "app/api/profile/[studentId]/route.ts",
          "app/api/profile/[studentId]/save/route.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/profile/{studentId}",
            "description": "Get student's saved major",
            "auth_required": true,
            "response_schema": {
              "200": "{major: string | null}",
              "401": "Unauthorized"
            }
          },
          {
            "method": "POST",
            "path": "/api/profile/{studentId}/save",
            "description": "Save or update student's chosen major",
            "auth_required": true,
            "request_schema": {
              "body": {
                "major": "string"
              }
            },
            "response_schema": {
              "200": "{success: true}",
              "401": "Unauthorized"
            }
          }
        ],
        "depends_on": [
          "Authentication"
        ]
      },
      {
        "name": "Student Progress API",
        "description": "Track and save completed courses per student per major",
        "files": [
          "app/api/progress/[studentId]/route.ts",
          "app/api/progress/[studentId]/save/route.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/progress/{studentId}?major=X",
            "description": "Get completed courses for a student and major",
            "auth_required": true,
            "response_schema": {
              "200": "{completed: Array of {code: string, name: string}}",
              "401": "Unauthorized"
            }
          },
          {
            "method": "POST",
            "path": "/api/progress/{studentId}/save",
            "description": "Save completed courses for a student",
            "auth_required": true,
            "request_schema": {
              "body": {
                "major": "string",
                "completed": [
                  {
                    "code": "string",
                    "name": "string"
                  }
                ]
              }
            },
            "response_schema": {
              "200": "{success: true}",
              "401": "Unauthorized"
            }
          }
        ],
        "depends_on": [
          "Authentication",
          "Student Profile API"
        ]
      },
      {
        "name": "Semester Planner API",
        "description": "CRUD operations for semester planner data including courses and study sessions",
        "files": [
          "app/api/planner/route.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/planner",
            "description": "Load authenticated user's planner",
            "auth_required": true,
            "response_schema": {
              "200": "{id: string, name: string, courses: array, studySessions: array}",
              "401": "Unauthorized"
            }
          },
          {
            "method": "POST",
            "path": "/api/planner",
            "description": "Save or update planner data",
            "auth_required": true,
            "request_schema": {
              "body": {
                "id": "string",
                "name": "string",
                "courses": "array",
                "studySessions": "array"
              }
            },
            "response_schema": {
              "200": "{success: true}",
              "401": "Unauthorized"
            }
          },
          {
            "method": "DELETE",
            "path": "/api/planner",
            "description": "Delete user's planner",
            "auth_required": true,
            "response_schema": {
              "200": "{success: true}",
              "401": "Unauthorized"
            }
          }
        ],
        "depends_on": [
          "Authentication"
        ]
      },
      {
        "name": "Google Calendar Integration",
        "description": "Push midterm and final exam dates as Google Calendar events with reminders",
        "files": [
          "app/api/integrations/google-calendar/route.ts",
          "app/api/integrations/google-calendar/callback/route.ts"
        ],
        "endpoints": [
          {
            "method": "POST",
            "path": "/api/integrations/google-calendar",
            "description": "Push exam dates to Google Calendar",
            "auth_required": true,
            "request_schema": {
              "body": {
                "courses": [
                  {
                    "name": "string",
                    "midtermDate": "string",
                    "finalDate": "string",
                    "credits": "number"
                  }
                ]
              }
            },
            "response_schema": {
              "200": "{success: true, eventsCreated: number}",
              "401": "Unauthorized"
            }
          },
          {
            "method": "GET",
            "path": "/api/integrations/google-calendar/callback",
            "description": "Google OAuth2 callback to exchange auth code for tokens",
            "auth_required": false,
            "response_schema": {
              "302": "Redirect to /planner"
            }
          }
        ],
        "depends_on": [
          "Authentication"
        ]
      },
      {
        "name": "Notion Integration",
        "description": "Sync courses to a Notion database under a Study Plan page",
        "files": [
          "app/api/integrations/notion/route.ts",
          "app/api/integrations/notion/callback/route.ts"
        ],
        "endpoints": [
          {
            "method": "POST",
            "path": "/api/integrations/notion",
            "description": "Sync courses to Notion database",
            "auth_required": true,
            "request_schema": {
              "body": {
                "courses": "array",
                "semesterName": "string",
                "createNewPage": "boolean"
              }
            },
            "response_schema": {
              "200": "{success: true}",
              "401": "Unauthorized"
            }
          },
          {
            "method": "GET",
            "path": "/api/integrations/notion/callback",
            "description": "Notion OAuth callback to exchange auth code for access token",
            "auth_required": false,
            "response_schema": {
              "302": "Redirect to /planner"
            }
          }
        ],
        "depends_on": [
          "Authentication"
        ]
      },
      {
        "name": "Admin Analytics API",
        "description": "Comprehensive analytics and visitor log endpoints for admin dashboard",
        "files": [
          "app/api/admin/stats/route.ts",
          "app/api/admin/logs/route.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/admin/stats",
            "description": "Get comprehensive analytics data including student counts, major distribution, traffic trends, device breakdown, activity heatmap",
            "auth_required": true,
            "response_schema": {
              "200": "{totalStudents: number, visitorCount: number, majorDistribution: object, progressDistribution: object, topCourses: array, trafficTrends: array, deviceBreakdown: object, recentActivity: array, heatmap: array, studentData: array}",
              "401": "Unauthorized - missing or invalid x-admin-secret header"
            }
          },
          {
            "method": "GET",
            "path": "/api/admin/logs",
            "description": "Fetch 100 most recent visitor log entries",
            "auth_required": true,
            "response_schema": {
              "200": "Array of visitor log entries",
              "401": "Unauthorized - missing or invalid x-admin-secret header"
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "Database Management API",
        "description": "Admin endpoints to initialize or reset database tables",
        "files": [
          "app/api/setup/route.ts",
          "app/api/reset/route.ts"
        ],
        "endpoints": [
          {
            "method": "POST",
            "path": "/api/setup",
            "description": "Initialize all database tables without dropping existing data",
            "auth_required": true,
            "response_schema": {
              "200": "{success: true}",
              "401": "Unauthorized - missing or invalid x-admin-secret header"
            }
          },
          {
            "method": "POST",
            "path": "/api/reset",
            "description": "Nuclear reset - drops and re-creates all database tables",
            "auth_required": true,
            "response_schema": {
              "200": "{success: true}",
              "401": "Unauthorized - missing or invalid x-admin-secret header"
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "Authentication",
        "description": "NextAuth-based authentication with credentials (student ID + password) and Google OAuth",
        "files": [
          "auth.ts",
          "app/api/auth/[...nextauth]/route.ts",
          "lib/database.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/auth/session",
            "description": "Get current session",
            "auth_required": false,
            "response_schema": {
              "200": "{user: {id, name, email, student_id} | null}"
            }
          },
          {
            "method": "POST",
            "path": "/api/auth/signin/credentials",
            "description": "Sign in with student ID and password",
            "auth_required": false,
            "request_schema": {
              "body": {
                "student_id": "string",
                "password": "string",
                "is_claiming": "string"
              }
            },
            "response_schema": {
              "200": "Session created",
              "401": "Invalid credentials"
            }
          },
          {
            "method": "POST",
            "path": "/api/auth/signout",
            "description": "Sign out and destroy session",
            "auth_required": false,
            "response_schema": {
              "200": "Session destroyed"
            }
          }
        ],
        "depends_on": []
      }
    ],
    "known_limitations": [
      {
        "issue": "No rate limiting on authentication endpoints",
        "location": "auth.ts",
        "impact": "Potential brute force attacks on login"
      },
      {
        "issue": "Admin secret passed via header without rate limiting",
        "location": "app/api/admin/stats/route.ts",
        "impact": "Admin endpoints could be brute-forced"
      },
      {
        "issue": "The reset endpoint drops all tables without confirmation",
        "location": "app/api/reset/route.ts",
        "impact": "Destructive operation with single header check"
      }
    ]
  }
}
